#!/usr/bin/env bash
#
# Auto-detect GPU, check system configuration, and enter the appropriate nix dev shell
#
set -e

cd "$(dirname "$0")"

GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

detected_gpus=()
recommended=""

# ── Pre-flight checks ────────────────────────────────────────────────────────

check_nix() {
    if ! command -v nix &> /dev/null; then
        echo -e "${RED}Nix is not installed.${NC} See https://nixos.org/download.html"
        exit 1
    fi

    if ! nix eval --expr 'true' &> /dev/null; then
        echo -e "${RED}Nix flakes are not enabled.${NC}"
        echo "Add to ~/.config/nix/nix.conf:"
        echo "  experimental-features = nix-command flakes"
        exit 1
    fi
}

# ── System checks (Linux only) ──────────────────────────────────────────────

check_system() {
    [[ "$(uname)" == "Darwin" ]] && return

    local issues=()

    # Check group membership
    if ! groups 2>/dev/null | grep -qw render; then
        issues+=("group:render")
    fi
    if ! groups 2>/dev/null | grep -qw video; then
        issues+=("group:video")
    fi

    # Check /run/opengl-driver symlink (nix-system-graphics)
    if [[ ! -e /run/opengl-driver ]]; then
        issues+=("opengl-driver")
    fi

    # Check GRUB GTT config for AMD APUs
    if lspci 2>/dev/null | grep -qiE "amd.*(radeon|graphics)|ati.*radeon"; then
        if ! grep -q "amdgpu.gttsize" /proc/cmdline 2>/dev/null; then
            issues+=("gtt")
        fi
    fi

    [[ ${#issues[@]} -eq 0 ]] && return

    echo ""
    echo -e "${YELLOW}=== System Configuration ===${NC}"
    echo ""
    echo "Some system settings need attention for GPU acceleration:"
    echo ""

    local missing_groups=()
    local needs_opengl_driver=false
    local needs_grub=false
    local needs_relogin=false

    for issue in "${issues[@]}"; do
        case "$issue" in
            group:*)
                local grp="${issue#group:}"
                echo -e "  ${RED}✗${NC} User not in '${grp}' group (needed for GPU device access)"
                missing_groups+=("$grp")
                ;;
            opengl-driver)
                echo -e "  ${RED}✗${NC} /run/opengl-driver missing (needed for Nix programs to find GPU drivers)"
                needs_opengl_driver=true
                ;;
            gtt)
                echo -e "  ${RED}✗${NC} AMD GPU memory (GTT) not configured (needed for large models on APUs)"
                needs_grub=true
                ;;
        esac
    done
    echo ""

    # Handle missing group membership
    if [[ ${#missing_groups[@]} -gt 0 ]]; then
        local groups_str="${missing_groups[*]}"
        echo "Adding user to groups: ${groups_str}"
        echo ""
        read -rp "Run sudo usermod now? [Y/n] " ans
        if [[ -z "$ans" || "$ans" == "y" || "$ans" == "Y" ]]; then
            for grp in "${missing_groups[@]}"; do
                sudo usermod -aG "$grp" "$USER"
            done
            echo -e "${GREEN}Group membership updated.${NC}"
            needs_relogin=true
        else
            echo -e "${YELLOW}Skipped.${NC} Run manually: sudo usermod -aG render,video \$USER"
        fi
        echo ""
    fi

    # Handle missing /run/opengl-driver
    if $needs_opengl_driver; then
        echo "Setting up GPU driver visibility via system-manager."
        echo "This creates the /run/opengl-driver symlink so Nix programs find GPU drivers."
        echo ""
        echo "Note: Nix may ask to trust numtide's binary cache — answer 'y' for pre-built"
        echo "binaries, or 'n' to build from source."
        echo ""
        read -rp "Run system-manager now? [Y/n] " ans
        if [[ -z "$ans" || "$ans" == "y" || "$ans" == "Y" ]]; then
            local nix_bin
            nix_bin=$(command -v nix)
            echo ""
            sudo "$nix_bin" --extra-experimental-features 'nix-command flakes' run 'github:numtide/system-manager' -- switch --flake '.'
            echo ""
            echo -e "${GREEN}GPU driver visibility configured.${NC}"
        else
            echo -e "${YELLOW}Skipped.${NC} You can run it manually later (see SETUP.md Step 8)."
        fi
        echo ""
    fi

    # Handle GRUB GTT configuration
    if $needs_grub; then
        configure_gtt
        echo ""
    fi

    # If group changes were made, user needs to re-login
    if $needs_relogin; then
        echo -e "${YELLOW}You need to logout and login again for group membership to take effect.${NC}"
        echo "After re-login, run ./dev again."
        exit 0
    fi
}

configure_gtt() {
    echo -e "${CYAN}── AMD GPU Memory Configuration ──${NC}"
    echo ""
    echo "AMD APUs (like Ryzen AI) share system RAM with the GPU."
    echo "The kernel limits how much RAM the GPU can use (GTT size)."
    echo "The default is too small for large LLM models."
    echo ""

    # Detect total system RAM in GB
    local total_kb
    total_kb=$(awk '/^MemTotal:/ { print $2 }' /proc/meminfo)
    local total_gb=$(( total_kb / 1024 / 1024 ))

    if [[ $total_gb -lt 1 ]]; then
        echo -e "${RED}Could not detect system RAM.${NC}"
        return
    fi

    echo "Detected system RAM: ${total_gb}GB"
    echo ""
    echo "How much RAM should the GPU be allowed to use?"
    echo ""

    local gb_100=$total_gb
    local gb_80=$(( total_gb * 80 / 100 ))

    echo -e "  ${GREEN}[1] ${gb_100}GB (100% — recommended for dedicated LLM machines)${NC}"
    echo "  [2] ${gb_80}GB (80% — leaves headroom for other tasks)"
    echo "  [3] Custom amount"
    echo "  [s] Skip"
    echo ""

    read -rp "Select option [1]: " choice

    local selected_gb
    case "$choice" in
        ""|1)
            selected_gb=$gb_100
            ;;
        2)
            selected_gb=$gb_80
            ;;
        3)
            read -rp "Enter GB for GPU memory (1-${total_gb}): " custom_gb
            if ! [[ "$custom_gb" =~ ^[0-9]+$ ]] || (( custom_gb < 1 || custom_gb > total_gb )); then
                echo "Invalid amount."
                return
            fi
            selected_gb=$custom_gb
            ;;
        s|S)
            echo -e "${YELLOW}Skipped.${NC} You can configure this manually later (see SETUP.md Step 6)."
            return
            ;;
        *)
            echo "Invalid selection."
            return
            ;;
    esac

    local gttsize=$(( selected_gb * 1024 ))
    local pages_limit=$(( selected_gb * 1024 * 256 ))

    echo ""
    echo "This will set the following kernel parameters in /etc/default/grub:"
    echo "  amdgpu.gttsize=${gttsize}  (${selected_gb}GB GPU memory)"
    echo "  ttm.pages_limit=${pages_limit}"
    echo "  amd_iommu=off"
    echo ""
    echo -e "${YELLOW}Requires sudo and a reboot to take effect.${NC}"
    echo ""
    read -rp "Apply GRUB configuration? [Y/n] " ans

    if [[ -z "$ans" || "$ans" == "y" || "$ans" == "Y" ]]; then
        local grub_file="/etc/default/grub"
        local new_params="quiet splash amd_iommu=off amdgpu.gttsize=${gttsize} ttm.pages_limit=${pages_limit}"

        if [[ ! -f "$grub_file" ]]; then
            echo -e "${RED}$grub_file not found. Is GRUB installed?${NC}"
            return
        fi

        # Replace or add GRUB_CMDLINE_LINUX_DEFAULT
        if grep -q "^GRUB_CMDLINE_LINUX_DEFAULT=" "$grub_file"; then
            sudo sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT=\"${new_params}\"|" "$grub_file"
        else
            echo "GRUB_CMDLINE_LINUX_DEFAULT=\"${new_params}\"" | sudo tee -a "$grub_file" > /dev/null
        fi

        echo ""
        sudo update-grub
        echo ""
        echo -e "${GREEN}GRUB configuration updated.${NC}"
        echo -e "${YELLOW}A reboot is required for the GPU memory changes to take effect.${NC}"
        echo ""
        read -rp "Reboot now? [y/N] " reboot_ans
        if [[ "$reboot_ans" == "y" || "$reboot_ans" == "Y" ]]; then
            sudo reboot
        else
            echo "Remember to reboot before using GPU acceleration with large models."
        fi
    else
        echo -e "${YELLOW}Skipped.${NC} You can configure this manually later (see SETUP.md Step 6)."
    fi
}

# ── GPU detection ────────────────────────────────────────────────────────────

detect_gpus() {
    # macOS: Metal only
    if [[ "$(uname)" == "Darwin" ]]; then
        detected_gpus+=("default:Metal (Apple Silicon)")
        recommended="default"
        return
    fi

    # Linux: check for GPU vendors via lspci
    if command -v lspci &> /dev/null; then
        local pci_output
        pci_output=$(lspci 2>/dev/null || true)

        # NVIDIA discrete GPU
        if echo "$pci_output" | grep -qi "nvidia"; then
            detected_gpus+=("nvidia:CUDA (NVIDIA)")
            recommended="nvidia"
        fi

        # AMD GPU (integrated or discrete)
        if echo "$pci_output" | grep -qiE "amd.*(radeon|graphics)|ati.*radeon"; then
            detected_gpus+=("vulkan:Vulkan (AMD)")
            [[ -z "$recommended" ]] && recommended="vulkan"
        fi

        # Intel integrated graphics
        if echo "$pci_output" | grep -qiE "intel.*(graphics|uhd|iris)"; then
            detected_gpus+=("vulkan:Vulkan (Intel)")
            [[ -z "$recommended" ]] && recommended="vulkan"
        fi
    fi

    # CPU fallback is always available
    detected_gpus+=("cpu:CPU only (no GPU acceleration)")

    # If nothing else detected, recommend CPU
    [[ -z "$recommended" ]] && recommended="cpu" || true
}

show_menu() {
    echo ""
    echo -e "${CYAN}=== Local LLM Toolbox - Environment Setup ===${NC}"
    echo ""
    echo "Detected hardware:"

    local i=1
    for entry in "${detected_gpus[@]}"; do
        local shell="${entry%%:*}"
        local desc="${entry#*:}"

        if [[ "$shell" == "$recommended" ]]; then
            echo -e "  ${GREEN}[$i] $desc (recommended)${NC}"
        else
            echo "  [$i] $desc"
        fi
        ((i++))
    done

    echo "  [q] Quit"
    echo ""
}

prompt_user() {
    local default_idx=1

    # Find index of recommended
    local i=1
    for entry in "${detected_gpus[@]}"; do
        local shell="${entry%%:*}"
        if [[ "$shell" == "$recommended" ]]; then
            default_idx=$i
            break
        fi
        ((i++))
    done

    read -rp "Select option or press Enter load the recommended environment: " choice

    # Y/y/Enter all accept the recommended option
    if [[ -z "$choice" || "$choice" == "y" || "$choice" == "Y" ]]; then
        choice=$default_idx
    fi

    if [[ "$choice" == "q" || "$choice" == "Q" ]]; then
        echo "Cancelled."
        exit 0
    fi

    if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#detected_gpus[@]} )); then
        echo "Invalid selection."
        exit 1
    fi

    local selected="${detected_gpus[$((choice-1))]}"
    local shell="${selected%%:*}"
    local desc="${selected#*:}"

    echo ""
    echo -e "Starting ${GREEN}$desc${NC} environment..."
    echo ""

    exec nix develop ".#$shell" "$@"
}

# ── Main ─────────────────────────────────────────────────────────────────────

# Allow direct override: ./dev nvidia
if [[ -n "$1" && "$1" != "-"* ]]; then
    check_nix
    check_system
    echo "Starting $1 environment..."
    exec nix develop ".#$1"
fi

check_nix
check_system
detect_gpus
show_menu
prompt_user "$@"
